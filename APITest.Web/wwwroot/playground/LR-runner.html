<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>




    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
            border: 0;
        }

        .monaco-editor {
            overflow: hidden;
        }
    </style>



</head>
<body>



    <script src="/lib/protobufjs/dist/protobuf.js"></script>

    <script>


       

     
        document.body.style.height = '100%';

        // Switch `automaticLayout` property to true by default
        //TODO: var config = require('vs/editor/common/config/config');
        //config.getActiveEditor().automaticLayout = true;

        window.load = function (js, html, css) {
            if (css) {
                var style = document.createElement("style");
                style.type = "text/css";
                style.innerHTML = css;
                document.body.appendChild(style);
            }
            if (html) {
                document.body.innerHTML += html;
            }
            if (js) {

                var wsUri = "ws://" + window.location.host + "/WS/HttpAgent";

                var websocket = new WebSocket(wsUri);

                var WSMessage;
                var MessageType;
                var LRFunction;
                websocket.onopen = function (evt) {
                    protobuf.load("/playground/WSMessage.proto", function (err, root) {
                        if (err) throw err;
                        WSMessage = root.lookup("APITest.Web.HttpAgent.WSMessage");
                        MessageType = root.lookup("APITest.Web.HttpAgent.MessageType");
                        LRFunction = root.lookup("APITest.Web.HttpAgent.LRFunction");


                        LRScriptRun(js, function (name, args) {
                            var lrFun = LRFunction.create({ name: name, args: args });
                            var lrBuffer = LRFunction.encode(lrFun).finish();

                            var msg = WSMessage.create({ type: MessageType.values.LRFunction, message: lrBuffer });
                          
                            var msgBuff = WSMessage.encode(msg).finish();
                            websocket.resOver = false;
                            websocket.send(msgBuff);

                            while (!websocket.resOver) {
                                Sleep(500);
                            }
                        })
                        websocket.close();
                    });
                  

                };
                websocket.onclose = function (evt) {
                    console.log("websocket close");
                };
                websocket.onmessage = function (evt) {
                    var reader = new FileReader();
                    reader.readAsArrayBuffer(evt.data);
                    reader.onload = function (e) {
                        var buf = new Uint8Array(reader.result);
                        var msg = WSMessage.decode(buf)
                        console.log("msg.type:" + msg.type);
                        if (msg.type == MessageType.values.LRFunctionRes)
                            websocket.resOver = true;
                    }
                };
                websocket.onerror = function (evt) {
                    console.log("websocket error");
                };

               
                
                
            }
        };

       
        function Sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms))
        }

       

        function LRScriptRun(code,callback) {
            var EXTRARES = "@EXTRARES";
            var LAST ="@LAST";
            var ENDITEM = "@ENDITEM";
            var ITEMDATA = "@ITEMDATA";
            

            function web_url() {
                callback("web_url",arguments);
            }

            try {
                eval(code);
            } catch (err) {
                console.log(err);
            }
           
        }

    </script>

</body>
</html>